## Materials and Methods

### Dataset
Zinc The average bond length corresponds to a resolution of ∼2.2 Å. Also, the deviation increases noticeably after the resolution exceeds 2.5 Å. [@doi:10.1021/ic401072d]

The input PDB files for training were obtained from the RCSB protein databank (Download 5. March 2021). We used a clustering at 30% sequence identity using MMSeqs2 as the input to largely remove sequence and structural redunancy in the input dataset. 
For each cluster we check whether a zinc is contained in one of the structures, whether the resolution of these structures is better than 2.5 A, the experimental method is X-Ray crystallography and whether the structure does not contain nucleic acids. If there are multiple structures fulfilling the criteria the highest resolution structure is used. Structures that fulfill all criteria except the zinc criterion are kept to for selectivity analysis for different metals. 
All structures larger than 3000 residues are discarded. 
The train/val/test split was performed based on sequence identity using `easy-search` in mmseqs. All proteins that had no (partial) sequence overlap with any other protein in the dataset were put into the test/val set (85 proteins) which we further split into a test set of 59 structures and 36 structures in the validation set. The test set contained 1614 structures. (Reported as csv Supplemental Data 1).



### Metal 1D

![Workflow of Metal1D](images/metal1D_scheme_large.png){#fig:metal1dworkflow}

The statistical analysis performed is focuses on the `LINK` records present in deposited PDB structures. In particular, this section of a PDB file specifies the connectivity between zinc (or any other metal ion) and the amino acids of the protein, and each `LINK` record specifies one `LINK`age. After having extracted the `LINK` records, data were filtered, only considering X-ray structures with resolution better than 2.5 Å. Aiming to obtain a statistically significant sample, for proteins which present more than one deposited structure, only the best-resolution one was used. This selection is based on the MOLECULE record of the deposited structures.
After the statistical filtering, a probability map is generated from the `LINK` records, extracting for each zinc ion the coordination experimentally observed. In this phase, `LINK` records involving only a single amino acid are excluded since they probably correspond to weak binding sites. In this phase, also `LINK` records containing water molecules are excluded. This is done for two reasons: in the first place, because it would be needed to restrict only to higher-resolution structure to have a reliable probability map including waters, which would drastically reduce the pool of structures used. Moreover, in the predicting phase, it would be needed to have protein structures with waters, which is not the general case due to experimental limitations and to difficulties to place water molecules a posteriori. Even if many tools are available, they are not able to handle the presence of metal ions. Due to these limitations, water molecules are considered only implicitly in this method.


The probability map is used to predict the metal sites for a given protein structure. To make a prediction, each amino acid of the protein is scored. The score is assigned performing a geometrical serch from a reference point, defined as the coordinate of the most probable metal binding atom, within a search radius, considered as twice the typical distance between the metal ion and the binding atom of amino acids in proteins. This quantity is enlarged of an arbitrary factor, in order to be able to take into account deviations from the ideal cooridnation and give more flexibility to the search. In case of amino acids which present more than one atom which typically binds metals, such as Histidine, the mid-point is used and the search radius is enlarged accordingly. 
The score is assigned to each amino acid considering all the other reference points of other amino acids within the search radius, and summing the probabilities in the probability map for coordinations compatible with the one observed. In the ideal case, a score of $1$ would correspond to an amino acid surrounded by all possible coordinating amino acids observed in the probability map. In practice, scores result between $0$ and less than $1$.

Once all amino acids in the chain are scored, site predictions are made grouping the highest-scored amino acids in clusters, based on distance. In practice, highest-scored amino acids are the ones with a score within a given threshold of the highest-scored one. For each cluster, a site prediction is made as a weighted average between the coordinates of the reference point of each amino acid, using as weighting factor the amino acid score. In the case of clusters composed of only one amino acid, to be able anyway to perform a site prediction, a fictitious score equal to the single highest-scored amino acid in the cluster is assigned to the nearby amino acid  (within the search radius) with the highest score. It is important to note that this amino acid was not in the highest-scored ones used to make the clusters, but in this way also for clusters with only one amino acid, a prediciton is made. The potential artefacts introduced by assigning a fictitious score to another amino acid is resolved by a final re-scoring of all the predicted sites.
This final re-scoring also mitigates the errors which can be introduced by calculating the site simply as a weighted average. In particular, a final geometrical search is performed around each predicted site (within 0.6 Å  the search radius, which as explained is about twice the typical metal-amino acid distance) and a score is now assigned to the site. This score is assigned in the same way as the amino acid scores, based on the probability map, and has the advantage of being able to sort the predicted metal sites based on their probability, according to the method. In this last re-scoring, sites with a probability lower than a certain threshold with respect to the highest-scored one, are excluded, in order to focus only on predictions with the highest probability. 

### Metal 3D

#### Voxelization
We used the moleculekit python library [@doi:10.1021/acs.jctc.6b00049; @doi:10.1093/bioinformatics/bty583]  to voxelize the input structures into 3D grids. 8 different input channels are used aromatic, hydrophobic, positive ionizable, negative ionizable, hbond donor, hbond acceptor, occupancy and metal ion binding site chain were used. For the target box only zinc ions were used. The target tensor was discretized setting any voxel above 0.05 to 1 (true location of zinc), all other to 0 (no zinc).  We used a box size of 20 Å centered on the CA residue of a residue, rotating each box randomly. The voxel grid used a 1 Å resolution. 
For all structures selected for the respective sets we partionied the residues of the protein into residues within 12 Å of a zinc ion and ones not within 12 Å of a zinc. To make a balanced set of examples we voxelize all residues that are close to a zinc and an equal amount of residues randomly drawn from the non-zinc binding residues. 
The environments are precomputed and stored in HDF5 files for concurrent access during training. In total 266283 environements were computed for the training set, XXX for the test set, XXX for the validation set. 

#### Model training
We used PyTorch 1.10 to train the model. All layers of the network are convolutional layers with filter size 3 Å except for the second layer where 4 Å size is used and the fifth layer where a 16 Å filter is used to capture long range interactions. We use zero padding to keep the size of the boxes constant. Models were trained on a workstation with 2x NVIDIA GTX2070 GPU and 28 CPU cores. 
Binary Cross Entropy [@doi:10.1007/s10479-005-5724-z] loss is used to train the model. The rectified linear unit (ReLU) non-linearity  is used except for the last layer which uses a sigmoid function which yields the probability for zinc per voxel.
A dropout layer (p = 0.2) was used between the 5th and 6th layer. 
The network was trained using AdaDelta, a stepped learning rate (lr=1.0, ɣ=0.7) a batch size of 500 and 12 epochs to train.

#### Hyperparameter tuning
Ray Tune following parameters were tuned with 15 different combinations:

- filtersize: 3,4
- dropout : 0.1, 0.2, 0.4, 0.5
- learning rate : 0.5, 1.0, 2.0
- gamma: 0.5, 0.7, 0.8, 0.9
- batch size: 128, 200, 500


#### HCA2 mutants 

Richardson Rotamer library 
EVOLVE-ddG
implicit solvent, double deprotonated histidines for rotamer optimization 
Zinc cationic dummy model 
