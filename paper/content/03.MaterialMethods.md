## Materials and Methods

### Dataset
The input PDB files for training were obtained from the RCSB protein databank (Download 5. March 2021). We used a clustering at 30% sequence identity using MMSeqs2 as the input to largely remove sequence and structural redunancy in the input dataset. 
For each cluster we check whether a zinc is contained in one of the structures, whether the resolution of these structures is better than 2.5 Å, the experimental method is X-Ray crystallography and whether the structure does not contain nucleic acids. If there are multiple structures fulfilling the criteria the highest resolution structure is used. Structures that fulfill all criteria except the zinc criterion are kept for the selectivity analysis for different metals. 
All structures larger than 3000 residues are discarded. We always use the first biological assembly as metals are often located at protein interfaces. All structures are filtered to only contain zinc and protein residues (including some non-standard amino acids MSE (CHECK which others)). If there are multiple models in the structure the first one is used. 
The train/val/test split was performed based on sequence identity using `easy-search` in mmseqs. All proteins that had no (partial) sequence overlap with any other protein in the dataset were put into the test/val set (85 proteins) which we further split into a test set of 59 structures and 36 structures in the validation set. The test set contained 1614 structures. (Reported as csv Supplemental Data 1).

For the selectivity analysis the clusters that did not contain zinc were randomly sampled to extract about 25 structures per metal (Supplemental Data 2) and all metal sites that had at minimum 3 unique protein ligands within 2.8 Å of the metal were used for the analysis to exclude any crystallization artefacts for the selectivity analyis. For the zinc analysis we used either all zinc ions contained in the structures or all that had at minimum 2 unique ligands within 2.8 Å of the metal. 

### Metal 1D

![Workflow of Metal1D](images/metal1D_scheme_large.png){#fig:metal1dworkflow}

The statistical analysis performed is focuses on the `LINK` records present in deposited PDB structures. In particular, this section of a PDB file specifies the connectivity between zinc (or any other metal ion) and the amino acids of the protein, and each `LINK` record specifies one `LINK`age. The idea of basing this approach on the `LINK`s is an extension to the approach by Barber-Zucker *et al.* [@doi:10.1038/s41598-017-16777-5], where they used the `LINK` records to investigate the propensity of transition metals to bind different amino acids, but not for the coordination.

In Metal1D, after the statistical filtering a probability map is generated from the `LINK` records, extracting for each zinc ion the oordination experimentally observed. In this phase, `LINK` records involving only a single amino acid are excluded since they probably correspond to weak binding sites. In this phase, also `LINK` records containing water molecules are excluded. This is done for two main reasons: a reliable probability map including waters would only include high-resolutioin structures, drastically reducing the pool of experimental structures used. Moreover, even using a probability map including water, in the predicting phase water molecules would need to be present in the investigated structure. However, this poses additional problem, because the quality of modeled water molecules in crystal structures varies [@doi:10.1016/0076-6879(86)27014-7]<!-- paper from 1986, we can also look for something more recent -->, other experimental or computational methods such as alpha fold do not provide water models, and it is difficult to add water molecules a posteriori [@doi:10.1016/j.csbj.2020.02.001]<!-- this is more a review on available softwares for waters, not sure this is what you had in mind-->. Even if many tools are available, Dowser++ [@doi:10.1002/prot.25081] and WaterDock2 [@doi:10.1371/journal.pone.0172743] among the most diffused and powerful ones, they are not able to handle the presence of metal ions. Due to these limitations, water molecules are considered only implicitly in this method.


The learned probability map is used to predict the metal sites for a given protein structure. To make a prediction, each amino acid of the protein is scored. The score is assigned performing a geometrical search from a reference point, defined as the coordinate of the most probable metal binding atom, within a search radius, considered as twice the typical distance between the metal ion and the binding atom of amino acids in proteins. This quantity is enlarged of an arbitrary factor, in order to be able to take into account deviations from the ideal cooridnation and give more flexibility to the search. In case of amino acids which present more than one atom which typically binds metals, such as Histidine, the mid-point is used and the search radius is enlarged accordingly. 
The score is assigned to each amino acid considering all the other reference points of other amino acids within the search radius, and summing the probabilities in the probability map for coordinations compatible with the one observed. In the ideal case, a score of 1 would correspond to an amino acid surrounded by all possible coordinating amino acids observed in the probability map. In practice, scores result between 0 and less than 1.

Once all amino acids in the chain are scored, site predictions are made grouping the highest-scored amino acids in clusters, based on distance. In practice, highest-scored amino acids are the ones with a score within a given threshold of the highest-scored one. For each cluster, a site prediction is made as a weighted average between the coordinates of the reference point of each amino acid, using as weighting factor the amino acid score. In the case of clusters composed of only one amino acid, to be able to place the metal, a fictitious score equal to the single highest-scored amino acid in the cluster is assigned to the nearby amino acid  (within the search radius) with the highest score. <!-- Did you try using some kind of bond vector ? I imagine this approach will have difficulty differntiating Ne Nd in histidines-->
 It is important to note that the fictitious score is assigned to be able to predict a site as a weighted average, for which two points are needed, also for clusters composed of only one high-scored amino acid. However, the potential artefacts introduced by assigning a fictitious score to another amino acid is resolved by a final re-scoring of all the predicted sites.
This final re-scoring also mitigates the errors which can be introduced by calculating the site simply as a weighted average. In particular, a final geometrical search is performed around each predicted site (within 60% of the search radius, which as explained is about twice the typical metal-amino acid distance) and a score is now assigned to the site. This score is assigned in the same way as the amino acid scores, based on the probability map, and has the advantage of being able to sort the predicted metal sites based on their probability, according to the method. In this last re-scoring, sites with a probability lower than a certain threshold with respect to the highest-scored one, are excluded, in order to focus only on predictions with the highest probability. 

### Metal 3D

#### Voxelization
We used the moleculekit python library [@doi:10.1021/acs.jctc.6b00049; @doi:10.1093/bioinformatics/bty583] to voxelize the input structures into 3D grids. 8 different input channels are used: aromatic, hydrophobic, positive ionizable, negative ionizable, hbond donor, hbond acceptor, occupancy and metal ion binding site chain were used. The scores are assigned using AutoDockVina atom names and a boolean mask. For each atom matching one of the categories a gaussian distribution wheighted by the vdW radius of the atom is used to assign the voxel value. For the target box only zinc ions were used. The target tensor was discretized setting any voxel above 0.05 to 1 (true location of zinc), all other to 0 (no zinc).  We used a box size of 20 Å centered on the CA residue of a residue, rotating each box randomly. The voxel grid used a 1 Å resolution. Any alternative conformations modeled were discarded keeping only the highest occupancy. 
For all structures selected for the respective sets we partioned the residues of the protein into residues within 12 Å of a zinc ion and ones not within 12 Å of a zinc. A single zinc site will therefore be present many times in the dataset but each time translated to the  To make a balanced set of examples we voxelize all residues that are close to a zinc and an equal amount of residues randomly drawn from the non-zinc binding residues. 
The environments are precomputed and stored in HDF5 files for concurrent access during training. In total 266283 environements were computed for the training set, XXX for the test set, XXX for the validation set. 

#### Model training
We used PyTorch 1.10 to train the model. All layers of the network are convolutional layers with filter size 3 Å except for the second layer where 4 Å size is used and the fifth layer where a 16 Å filter is used to capture long range interactions. We use zero padding to keep the size of the boxes constant. Models were trained on a workstation with 2x NVIDIA GTX2070 GPU and 28 CPU cores. 
Binary Cross Entropy [@doi:10.1007/s10479-005-5724-z] loss is used to train the model. The rectified linear unit (ReLU) non-linearity  is used except for the last layer which uses a sigmoid function which yields the probability for zinc per voxel.
A dropout layer (p = 0.2) was used between the 5th and 6th layer. 
The network was trained using AdaDelta, a stepped learning rate (lr=1.0, ɣ=0.7) a batch size of 500 and 12 epochs to train.

#### Hyperparameter tuning
Ray Tune following parameters were tuned with 15 different combinations:

- filtersize: 3,4
- dropout : 0.1, 0.2, 0.4, 0.5
- learning rate : 0.5, 1.0, 2.0
- gamma: 0.5, 0.7, 0.8, 0.9
- batch size: 128, 200, 500


#### Grid Averaging <!-- I changed it to a subsubsub section (####), before it was just # but I think it was not meant -->

Predictions for a complete protein are obtained by voxelizing select residues of the protein (default all cysteines, histidines, aspartates, glutamates) and averaging the boxes using a global grid. The global grid is obtained by computing the bounding box of all points. In between the bounding box a regular grid at 1 A intervals is computed. Using the KD-Tree implementation in scipy for each grid point all close points within 1 A are taken and the voxel value is set as the mean probability from all points. The output is saved as cube file. 

#### HCA2 mutants 
The HCA2 mutants were extracted from Ref [@doi:Fierke etc] and the crystal structure 2CBA [@doi:] was used. The zinc was modeled using the zinc cationic dummy model forcefield [@pmid:11106157] and we verified that energy minization produced the correct coordiantion environment. The richardson rotamer library was used with the EVOLVE-ddG energy function to compute the most stable rotamer for a given mutation. The lowest-energy mutant was used for the prediction of the location of metals.

#### Evaluation 

To evaluate the trained model we monitored how accurately the model predicts the metal density of the test set. We used a discretized version of the jaccard index setting each voxel either as 0 (no metal) or  1 (zinc present). We tested multiple different decision boundaries 0.5, 0.6, 0.75, 0.90 and also comparing a slightly smaller centered box to remove any spurious density at the box edges. 